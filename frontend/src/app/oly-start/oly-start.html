<h2>Olympiade läuft!</h2>

<div *ngIf="isLoading()">
  <p>Lade Olympiade-Daten...</p>
</div>

<div *ngIf="!isLoading() && isActive()">

  <div class="players-list">
    <h3>Teilnehmer</h3>
    <ul *ngIf="players().length > 0; else noPlayers">
      <li *ngFor="let player of players()">
        {{ player.username }}: {{ player.score }} Punkte
      </li>
    </ul>
    <ng-template #noPlayers><p>Noch keine Spieler beigetreten.</p></ng-template>

    <button *ngIf="currentUser() && !isCurrentUserJoined()" (click)="joinGame()">
      Olympiade beitreten
    </button>
    <p *ngIf="!currentUser()">Bitte einloggen, um beizutreten.</p>
    <p *ngIf="isCurrentUserJoined()">Du bist dabei!</p>
  </div>

  <div class="game-selection" *ngIf="players().length > 0">
    <h3>Spielauswahl ({{ results().length }} / {{ selectedGamesList().length }} gespielt)</h3>

    <div *ngIf="currentGame(); let game">
      <div *ngIf="canDeclareWinner()">
        <h4>Aktuelles Spiel (Runde {{ results().length + 1 }} - {{ results().length + 1 }} Punkte):</h4>
        <p class="current-game">{{ game.name }}</p>
        Gewinner auswählen:
        <select #winnerSelect>
          <option *ngFor="let player of players()" [value]="player.userId">
            {{ player.username }}
          </option>
        </select>
        <button (click)="declareWinner(+winnerSelect.value)">Gewinner bestätigen</button>
      </div>
    </div>

    <div #wheelContainer class="wheel-container"
         *ngIf="!isLoading() && isActive() && players().length > 0 && availableGamesForWheel().length > 0 && !canDeclareWinner() && !isOlympiadeFinished()">
        <div class="wheel-pointer">▼</div>
        <p *ngIf="!isSpinning()">Wähle nächstes Spiel...</p>
        <p *ngIf="isSpinning()">Dreht...</p>
    </div>

    <div *ngIf="!isSpinning() && canSelectNextGame() && !canDeclareWinner()">
       <ng-container *ngIf="selectedGamesList().length > nextGameIndex()">
            <button (click)="selectGameManually(selectedGamesList()[nextGameIndex()].id)">
                Nächstes: {{ selectedGamesList()[nextGameIndex()].name }}
            </button>
       </ng-container>
       <button (click)="selectGameRandomly()" [disabled]="isSpinning()">Zufälliges Spiel drehen</button>
    </div>

     <p *ngIf="isOlympiadeFinished()">Alle Spiele gespielt!</p>
  </div>

  <div class="games-list">
    <h4>Spiele in dieser Olympiade:</h4>
    <ul>
      <li *ngFor="let game of selectedGamesList(); let i = index"
          [class.current-game]="i === currentGameIndex()"
          [class.played-game]="isGamePlayed(game.id)">
        {{ i + 1 }}. {{ game.name }}
        <ng-container *ngIf="isGamePlayed(game.id)">
          <ng-container *ngIf="getResultForGame(game.id) as gameResult">
            <span> - Gewinner: {{ getWinnerName(gameResult.winnerUserId) }} ({{ gameResult.pointsAwarded }} Pkt.)</span>
          </ng-container>
        </ng-container>
      </li>
    </ul>
  </div>

  <button (click)="finishOlympiade()">Olympiade Beenden & Ergebnisse speichern</button>

</div>

<div *ngIf="!isLoading() && !isActive()">
  <p>Derzeit läuft keine Olympiade.</p>
  <button (click)="router.navigate(['/oly'])">Neue Olympiade starten</button>
</div>