<h2>Olympiade läuft!</h2>

<div *ngIf="isLoading()">
  <p>Lade Olympiade-Daten...</p>
</div>

<div class="oly-layout" *ngIf="!isLoading() && isActive()">

  <div class="oly-column player-column">
    <h3>Teilnehmer</h3>
    
    <ul *ngIf="players().length > 0; else noPlayers" class="player-list">
      <li *ngFor="let player of players()" 
          class="player-card"
          [style.--player-color-hex]="player.personalColor || '#FFFFFF'"
          [style.--player-color-rgb]="hexToRgb(player.personalColor || '#FFFFFF')">
        
        <img [src]="player.avatarUrl || '/Portrait_Placeholder.png'" alt="Avatar" class="player-avatar">
        
        <div class="player-info">
          <span class="player-name">
            {{ player.username }}
            <span *ngIf="player.userId === currentUser()?.userId">(Du)</span>
          </span>
          <span class="player-score">{{ player.score }} Punkte</span>
        </div>
      </li>
    </ul>
    <ng-template #noPlayers><p>Noch keine Spieler beigetreten.</p></ng-template>

    <button *ngIf="currentUser() && !isCurrentUserJoined()" (click)="joinGame()" class="join-button">
      Olympiade beitreten
    </button>
    <p *ngIf="!currentUser()">Bitte einloggen, um beizutreten.</p>
  </div>

  <div class="oly-column game-control-column">
    <h3>Spielsteuerung ({{ results().length }} / {{ selectedGamesList().length }} gespielt)</h3>

    <div *ngIf="currentGame(); let game">
      <div *ngIf="canDeclareWinner()">
        <h4>Aktuelles Spiel (Runde {{ results().length + 1 }} - {{ results().length + 1 }} Punkte):</h4>
        <p class="current-game-title">{{ game.name }}</p>
        
        <div class="winner-selection">
          Gewinner auswählen:
          <select #winnerSelect>
            <option *ngFor="let player of players()" [value]="player.userId">
              {{ player.username }}
            </option>
          </select>
          <button (click)="declareWinner(+winnerSelect.value)">Gewinner bestätigen</button>
        </div>
      </div>
    </div>

    <div #wheelContainer class="wheel-container">
        <p *ngIf="!isSpinning() && !canDeclareWinner()">Wähle nächstes Spiel...</p>
        <div class="wheel-pointer">▼</div>
        <p *ngIf="isSpinning()">Dreht...</p>
        <p *ngIf="canDeclareWinner()">Wähle einen Gewinner (oben)...</p>
    </div>

    <div *ngIf="!isSpinning() && canSelectNextGame() && !canDeclareWinner()" class="game-selection-buttons">
       
       <button (click)="selectGameRandomly()" [disabled]="isSpinning()">Zufälliges Spiel drehen</button>

       <div class="manual-selection">
         <label for="manual-game-select">Oder manuell wählen:</label>
         <select #manualGameSelect>
           <option *ngFor="let game of availableGamesForWheel()" [value]="game.id">
             {{ game.name }}
           </option>
         </select>
         <button (click)="selectGameManually(+manualGameSelect.value)" [disabled]="availableGamesForWheel().length === 0 || isSpinning()">
           Dieses Spiel starten
         </button>
       </div>
    </div>

     <p *ngIf="isOlympiadeFinished()" class="finished-text">Alle Spiele gespielt!</p>
  </div>

  <div class="oly-column results-column">
    <h3>Ergebnisse & Spielplan</h3>
    
    <ul class="results-list">
      <li *ngFor="let game of selectedGamesList(); let i = index"
          class="game-result-card"
          [class.is-played]="isGamePlayed(game.id)"
          [class.is-current]="i === currentGameIndex()"
          [style.--player-color-hex]="getPlayer(getResultForGame(game.id)?.winnerUserId)?.personalColor || '#AAAAAA'"
          [style.--player-color-rgb]="hexToRgb(getPlayer(getResultForGame(game.id)?.winnerUserId)?.personalColor || '#AAAAAA')">
        
        <span class="game-name">{{ i + 1 }}. {{ game.name }}</span>

        <ng-container *ngIf="getResultForGame(game.id) as gameResult">
          <div class="winner-info"
               [style.background-color]="getPlayer(gameResult.winnerUserId)?.personalColor || '#eee'"
               [style.color]="getContrastColor(getPlayer(gameResult.winnerUserId)?.personalColor || '#eee')">
            
            <img [src]="getPlayer(gameResult.winnerUserId)?.avatarUrl || '/Portrait_Placeholder.png'" alt="Winner Avatar" class="winner-avatar">
            <span>
              Gewinner: {{ getWinnerName(gameResult.winnerUserId) }} ({{ gameResult.pointsAwarded }} Pkt.)
            </span>
          </div>
        </ng-container>

        <ng-container *ngIf="!isGamePlayed(game.id) && i === currentGameIndex()">
           <span class="game-pending current-text">► Aktuelles Spiel!</span>
        </ng-container>
        
        <ng-container *ngIf="!isGamePlayed(game.id) && i !== currentGameIndex()">
          <span class="game-pending">Steht noch aus...</span>
        </ng-container>
      </li>
    </ul>
  </div>

</div>

<div *ngIf="!isLoading() && isActive()" class="footer-controls">
  <button (click)="finishOlympiade()">Olympiade Beenden & Ergebnisse speichern</button>
</div>

<div *ngIf="!isLoading() && !isActive()">
  <p>Derzeit läuft keine Olympiade.</p>
  <button (click)="router.navigate(['/oly'])">Neue Olympiade starten</button>
</div>