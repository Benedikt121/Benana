<div *ngIf="gameState" class="kniffel-layout">
  
  <div class="kniffel-container">
    
    <div id="dice-box-background">
      <div id="dice-box-physics"></div>
    </div>
    <hr>

<div class="controls">
  <button *ngIf="gameState.isActive" 
          (click)="rollDice()" 
          [disabled]="!amICurrentPlayer || gameState.rollCount >= 3 || isRolling || isInitializing">
    {{ isInitializing ? 'Lade Würfel...' : 'Würfeln (Wurf ' + (gameState.rollCount + 1) + ')' }}
  </button>

  <button *ngIf="gameState.isActive || gameState.players.length === 0" 
          (click)="newGame()" 
          [disabled]="isInitializing">
    Neues Spiel
  </button>

  <button *ngIf="!gameState.isActive && gameState.players.length > 0" 
          (click)="saveGameAndExit()" 
          [disabled]="isSaving()">
    {{ isSaving() ? 'Speichere...' : 'Spiel speichern & Beenden' }}
  </button>
</div>

    <p *ngIf="amICurrentPlayer && !isRolling">
      Du bist am Zug.
    </p>
    <p *ngIf="!amICurrentPlayer && gameState.currentPlayerSocketId && !isRolling">
      Warte auf {{ currentPlayerUsername }}...
    </p>
    <p *ngIf="isRolling">
      Würfel rollen...
    </p>

    <div class="dice-display">
      <div *ngFor="let kd of gameState.currentDice; let i = index" 
           class="die-value"
           [class.held]="kd.isHeld"
           (click)="toggleHold(i)">
        <span>{{ kd.die.value }}</span>
        <small *ngIf="kd.isHeld">Gehalten</small>
      </div>
    </div>
  </div>

  <div class="scoreboard-wrapper">
    
    <div *ngFor="let player of gameState.players" class="scoreboard-container"
     [class.is-active-player]="player.socketId === gameState.currentPlayerSocketId"
     [style.--player-color-hex]="player.personalColor || '#FFFFFF'"
     [style.--player-color-rgb]="hexToRgb(player.personalColor || '#FFFFFF')"
     [style.--player-color-contrast]="getContrastColor(player.personalColor || '#FFFFFF')">
      
      <h3 class="scoreboard-header">
        <img [src]="player.avatarUrl || '/Portrait_Placeholder.png'" alt="Avatar" class="scoreboard-avatar">
        <span>
          {{ player.username }} 
          <span *ngIf="player.userId === myUserId">(Du)</span>
        </span>
      </h3>
      
      <ng-container *ngIf="gameState.scoreboards[player.userId] as scoreboard">
        <ng-container *ngIf="gameState.totalScores[player.userId] as totals">

          <div class="scoreboard-section">
            <ng-container *ngFor="let row of scoreboard">
              <div *ngIf="row.section === 'upper'" 
                   class="scoreboard-row"
                   [class.is-set]="row.isSet"
                   [class.is-clickable]="!row.isSet && amICurrentPlayer && gameState.rollCount > 0"
                   (click)="selectScore(row)">
                
                <span class="row-name">{{ row.name }}</span>
                <span class="row-score">
                  {{ row.isSet ? row.score : (amICurrentPlayer && gameState.rollCount > 0 ? row.potentialScore : '-') }}
                </span>
              </div>
            </ng-container>
          </div>
          
          <div class="scoreboard-total-row">
            <span class="row-name">Zwischensumme</span>
            <span class="row-score">{{ totals.upper }}</span>
          </div>
          <div class="scoreboard-total-row">
            <span class="row-name">Bonus (bei 63)</span>
            <span class="row-score">{{ totals.bonus }}</span>
          </div>
          <div class="scoreboard-total-row final-total">
            <span class="row-name">Summe Oben</span>
            <span class="row-score">{{ totals.upperTotal }}</span>
          </div>
          
          <div class="scoreboard-section">
            <ng-container *ngFor="let row of scoreboard">
              <div *ngIf="row.section === 'lower'" 
                   class="scoreboard-row"
                   [class.is-set]="row.isSet"
                   [class.is-clickable]="!row.isSet && amICurrentPlayer && gameState.rollCount > 0"
                   (click)="selectScore(row)">
                
                <span class="row-name">{{ row.name }}</span>
                <span class="row-score">
                  {{ row.isSet ? row.score : (amICurrentPlayer && gameState.rollCount > 0 ? row.potentialScore : '-') }}
                </span>
              </div>
            </ng-container>
          </div>

          <div class="scoreboard-total-row final-total">
            <span class="row-name">Summe Unten</span>
            <span class="row-score">{{ totals.lowerTotal }}</span>
          </div>
          
          <div class="scoreboard-total-row grand-total">
            <span class="row-name">Gesamt</span>
            <span class="row-score">{{ totals.grandTotal }}</span>
          </div>

        </ng-container>
      </ng-container>
    </div>
  </div>
</div>